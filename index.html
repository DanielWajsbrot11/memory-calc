<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise RAG Storage Calculator (Improved)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .input-field {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        .label-help {
            font-size: 12px;
            color: #888;
            font-weight: 400;
            margin-left: 5px;
        }
        input, select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        .result-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-label {
            font-weight: 600;
        }
        .result-value {
            font-family: 'Monaco', 'Courier New', monospace;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .cost-highlight {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .cost-highlight h3 {
            margin-top: 0;
            color: #155724;
        }
        .breakdown {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        .breakdown h3 {
            background: #3498db;
            color: white;
            margin: 0;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
        }
        .breakdown-content {
            padding: 20px;
        }
        .assumption {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            color: #721c24;
        }
        .tech-details {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #f4f4f4;
            padding: 15px;
            border-radius: 6px;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            width: 100%;
        }
        button:hover {
            background: #2980b9;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .winner {
            background: #d4edda;
            font-weight: 600;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
    </style>
</head>
<body>
    <p><strong>NOTE:</strong>This is a WIP and may not be 100% accurate</p>
    <p><strong>Context:</strong> Accurate storage and cost estimation for Redis Stack vs PostgreSQL + pgvector for conversation memory in enterprise n8n workflows.</p>
    <div class="container">
        <h1>üöÄ Enterprise RAG Storage Calculator (v2.0)</h1>
        
        <h2>üìä Input Parameters</h2>
        <div class="input-group">
            <div class="input-field">
                <label for="totalUsers">Total Users</label>
                <input type="number" id="totalUsers" value="500" min="1">
            </div>
            <div class="input-field">
                <label for="activeUserPercent">% Active Users (monthly)</label>
                <input type="number" id="activeUserPercent" value="80" min="1" max="100">
            </div>
            <div class="input-field">
                <label for="conversationsPerUser">Conversations per Active User/Month</label>
                <input type="number" id="conversationsPerUser" value="20" min="1">
            </div>
            <div class="input-field">
                <label for="messagesPerConversation">Average Messages per Conversation</label>
                <input type="number" id="messagesPerConversation" value="15" min="1">
            </div>
            <div class="input-field">
                <label for="avgMessageLength">Average Message Length (chars)</label>
                <input type="number" id="avgMessageLength" value="150" min="1">
            </div>
            <div class="input-field">
                <label for="chunkSize">Chunk Size for Embeddings (chars)</label>
                <input type="number" id="chunkSize" value="500" min="1">
            </div>
            <div class="input-field">
                <label for="embeddingDimensions">Embedding Dimensions</label>
                <select id="embeddingDimensions">
                    <option value="384">384 (small models)</option>
                    <option value="768">768 (medium models)</option>
                    <option value="1536" selected>1536 (OpenAI ada-002)</option>
                    <option value="3072">3072 (OpenAI large)</option>
                </select>
            </div>
            <div class="input-field">
                <label for="retentionMonths">Data Retention (months)</label>
                <input type="number" id="retentionMonths" value="12" min="1">
            </div>
        </div>

        <h2>üîß Advanced Options</h2>
        <div class="input-group">
            <div class="input-field">
                <label for="redisProvider">Redis Provider</label>
                <select id="redisProvider">
                    <option value="35">Google Memorystore (~$35/GB/mo)</option>
                    <option value="58" selected>AWS ElastiCache (~$58/GB/mo)</option>
                    <option value="70">Redis Cloud (~$70/GB/mo)</option>
                    <option value="45">Azure Cache Standard (~$45/GB/mo)</option>
                    <option value="80">Azure Enterprise (~$80/GB/mo)</option>
                </select>
            </div>
            <div class="input-field">
                <label for="postgresComputeSize">PostgreSQL Compute Tier</label>
                <select id="postgresComputeSize">
                    <option value="50">Light (db.t3.small - $50/mo)</option>
                    <option value="150" selected>Medium (db.t3.large - $150/mo)</option>
                    <option value="300">Heavy (db.r5.xlarge - $300/mo)</option>
                    <option value="600">Enterprise (db.r5.2xlarge - $600/mo)</option>
                </select>
            </div>
            <div class="input-field">
                <label for="replicationFactor">Replication Factor <span class="label-help">(for HA/DR)</span></label>
                <select id="replicationFactor">
                    <option value="1">1x (No replication)</option>
                    <option value="2" selected>2x (Primary + Replica)</option>
                    <option value="3">3x (High availability)</option>
                </select>
            </div>
            <div class="input-field">
                <label for="compressionRatio">Compression Ratio <span class="label-help">(for text)</span></label>
                <select id="compressionRatio">
                    <option value="1">None (1.0x)</option>
                    <option value="0.7">Light (0.7x)</option>
                    <option value="0.5" selected>Medium (0.5x)</option>
                    <option value="0.3">Heavy (0.3x)</option>
                </select>
            </div>
            <div class="input-field">
                <label for="vectorIndexType">Vector Index Type</label>
                <select id="vectorIndexType">
                    <option value="2.5" selected>HNSW (2.5x overhead)</option>
                    <option value="1.5">IVFFlat (1.5x overhead)</option>
                    <option value="3.0">HNSW + Quantization (3.0x)</option>
                </select>
            </div>
            <div class="input-field">
                <label for="backupStorage">Include Backup Storage?</label>
                <select id="backupStorage">
                    <option value="false">No</option>
                    <option value="true" selected>Yes (1x additional)</option>
                </select>
            </div>
        </div>

        <button onclick="calculateStorage()">üßÆ Calculate Storage Requirements</button>

        <div id="results" class="results" style="display: none;">
            <h2>üíæ Storage Projections</h2>
            <div class="result-item">
                <span class="result-label">Monthly Text Data:</span>
                <span class="result-value" id="monthlyText">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Monthly Vector Data:</span>
                <span class="result-value" id="monthlyVectors">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Total Monthly Storage:</span>
                <span class="result-value" id="monthlyTotal">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Annual Storage (with retention):</span>
                <span class="result-value" id="annualTotal">-</span>
            </div>
            
            <div class="cost-highlight">
                <h3>üí∞ Annual Cost Comparison</h3>
                <div class="result-item">
                    <span class="result-label">Redis Stack (in-memory):</span>
                    <span class="result-value" id="redisCostTotal" style="font-size: 16px; font-weight: bold;">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">PostgreSQL + pgvector (disk):</span>
                    <span class="result-value" id="pgCostTotal" style="font-size: 16px; font-weight: bold;">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">üí° Savings with PostgreSQL:</span>
                    <span class="result-value" id="savings" style="font-size: 16px; font-weight: bold; color: #28a745;">-</span>
                </div>
            </div>
            
            <div class="cost-chart-section" id="costChart" style="display: none;">
                <h3 style="color: #2c3e50; margin-top: 20px;">üìä Cost Breakdown Analysis</h3>
                <canvas id="costComparisonChart" style="max-height: 400px; margin: 20px 0;"></canvas>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107;">
                        <h4 style="margin-top: 0; color: #856404;">üí° Key Insights</h4>
                        <div id="costInsights"></div>
                    </div>
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; border: 2px solid #17a2b8;">
                        <h4 style="margin-top: 0; color: #0c5460;">üìà Cost Projections</h4>
                        <div id="costProjections"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="breakdown" style="display: none;">
            <div class="breakdown">
                <h3>üìã Detailed Calculation Breakdown</h3>
                <div class="breakdown-content">
                    <h4>Step 1: Calculate Total Messages</h4>
                    <div class="tech-details" id="step1">-</div>

                    <h4>Step 2: Calculate Text Storage (with compression)</h4>
                    <div class="tech-details" id="step2">-</div>

                    <h4>Step 3: Calculate Embedding Chunks</h4>
                    <div class="tech-details" id="step3">-</div>

                    <h4>Step 4: Calculate Vector Storage (with index overhead)</h4>
                    <div class="tech-details" id="step4">-</div>

                    <h4>Step 5: Calculate Total with Replication & Backup</h4>
                    <div class="tech-details" id="step5">-</div>

                    <h4>Step 6: Calculate Annual Costs</h4>
                    <div class="tech-details" id="step6">-</div>
                </div>
            </div>

            <div class="breakdown">
                <h3>‚öñÔ∏è Redis Stack vs PostgreSQL + pgvector</h3>
                <div class="breakdown-content">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Redis Stack</th>
                                <th>PostgreSQL + pgvector</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Storage Type</td>
                                <td>In-memory (with persistence)</td>
                                <td>Disk-based with caching</td>
                            </tr>
                            <tr>
                                <td>Index Structure</td>
                                <td>HNSW graphs</td>
                                <td>HNSW or IVFFlat</td>
                            </tr>
                            <tr>
                                <td>Storage Cost</td>
                                <td id="redisStorageCost">-</td>
                                <td id="pgStorageCost">-</td>
                            </tr>
                            <tr>
                                <td>Compute Cost</td>
                                <td id="redisComputeCost">Included in storage</td>
                                <td id="pgComputeCost">~$50-200/month (separate)</td>
                            </tr>
                            <tr>
                                <td>Query Speed</td>
                                <td>Very Fast (sub-ms)</td>
                                <td>Fast (1-10ms with proper indexing)</td>
                            </tr>
                            <tr>
                                <td>User Isolation</td>
                                <td>Key prefixing</td>
                                <td>Native relational structure</td>
                            </tr>
                            <tr>
                                <td>Scaling Pattern</td>
                                <td>Vertical (larger instances)</td>
                                <td>Horizontal (sharding) + Vertical</td>
                            </tr>
                            <tr id="bestForRow">
                                <td>Recommended For</td>
                                <td id="redisRecommendation">-</td>
                                <td id="pgRecommendation">-</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="assumption">
                        <strong>üìå Key Assumptions & Pricing:</strong>
                        <ul>
                            <li><strong>Redis In-Memory:</strong> $35-80/GB/month depending on provider (Google Memorystore cheapest, Azure Enterprise highest)</li>
                            <li><strong>PostgreSQL Storage:</strong> $0.115/GB/month for GP3 SSD (AWS RDS pricing)</li>
                            <li><strong>PostgreSQL Compute:</strong> $50-600/month depending on instance size (separate from storage)</li>
                            <li>Vector embeddings use float32 (4 bytes per dimension)</li>
                            <li>Text metadata overhead: 30% Redis, 40% PostgreSQL (for keys, indexes, relational structure)</li>
                            <li>Vector index overhead varies by type (HNSW typically 2.5x raw vector size in production)</li>
                            <li>Compression applied only to text data, not vector embeddings</li>
                            <li>Replication multiplies storage requirements (2x for primary+replica, 3x for multi-region HA)</li>
                        </ul>
                    </div>
                    
                    <div class="warning">
                        <strong>‚ö†Ô∏è Pricing Disclaimer:</strong>
                        <p>These estimates use publicly available pricing as of December 2024. Actual costs vary based on:</p>
                        <ul>
                            <li>Cloud provider and region (prices can differ by 20-40% between regions)</li>
                            <li>Commitment discounts (1-3 year reserved instances save 30-60%)</li>
                            <li>Enterprise agreements and volume discounts</li>
                            <li>Network egress costs (data transfer out to internet/regions)</li>
                            <li>Additional features (monitoring, enhanced security, compliance)</li>
                        </ul>
                        <p><strong>Always verify with your provider's pricing calculator for exact costs.</strong></p>
                    </div>
                </div>
            </div>

            <div class="breakdown">
                <h3>üí° Recommendations</h3>
                <div class="breakdown-content" id="recommendations">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <div class="breakdown">
                <h3>‚ö†Ô∏è Important Considerations</h3>
                <div class="breakdown-content">
                    <div class="warning">
                        <strong>Production Gotchas:</strong>
                        <ul>
                            <li><strong>Redis Memory Spikes:</strong> HNSW index rebuilds can temporarily require 2x storage</li>
                            <li><strong>Cold Start:</strong> Redis requires full data load into memory on restart (can take hours for large datasets)</li>
                            <li><strong>PostgreSQL I/O:</strong> Ensure SSD storage (NVMe preferred) for acceptable query performance</li>
                            <li><strong>Connection Pooling:</strong> Both require proper connection pooling for 500+ concurrent users</li>
                            <li><strong>Backup Windows:</strong> Large Redis snapshots can cause latency spikes</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatCurrency(amount) {
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calculateStorage() {
            // Get inputs
            const totalUsers = parseInt(document.getElementById('totalUsers').value);
            const activePercent = parseInt(document.getElementById('activeUserPercent').value) / 100;
            const conversationsPerUser = parseInt(document.getElementById('conversationsPerUser').value);
            const messagesPerConv = parseInt(document.getElementById('messagesPerConversation').value);
            const avgMessageLength = parseInt(document.getElementById('avgMessageLength').value);
            const chunkSize = parseInt(document.getElementById('chunkSize').value);
            const embeddingDims = parseInt(document.getElementById('embeddingDimensions').value);
            const retentionMonths = parseInt(document.getElementById('retentionMonths').value);
            
            // Advanced options
            const replicationFactor = parseInt(document.getElementById('replicationFactor').value);
            const compressionRatio = parseFloat(document.getElementById('compressionRatio').value);
            const vectorIndexMultiplier = parseFloat(document.getElementById('vectorIndexType').value);
            const includeBackup = document.getElementById('backupStorage').value === 'true';
            const redisMonthlyRate = parseFloat(document.getElementById('redisProvider').value);
            const pgComputeMonthlyCost = parseFloat(document.getElementById('postgresComputeSize').value);

            // Step 1: Calculate total messages per month
            const activeUsers = totalUsers * activePercent;
            const totalConversations = activeUsers * conversationsPerUser;
            const totalMessages = totalConversations * messagesPerConv;

            document.getElementById('step1').textContent = 
`Active Users = ${totalUsers} √ó ${(activePercent * 100).toFixed(0)}% = ${activeUsers.toFixed(0)}
Total Conversations/Month = ${activeUsers.toFixed(0)} √ó ${conversationsPerUser} = ${totalConversations.toFixed(0)}
Total Messages/Month = ${totalConversations.toFixed(0)} √ó ${messagesPerConv} = ${totalMessages.toFixed(0)}`;

            // Step 2: Calculate text storage with compression
            const totalTextChars = totalMessages * avgMessageLength;
            const textStorageBytes = totalTextChars; // 1 byte per char (UTF-8 average)
            const textCompressed = textStorageBytes * compressionRatio;
            
            // Metadata overhead (more realistic)
            const redisTextOverhead = 1.3; // 30% overhead for Redis hashes/keys
            const pgTextOverhead = 1.4; // 40% overhead for relational structure
            
            const textStorageRedis = textCompressed * redisTextOverhead;
            const textStoragePg = textCompressed * pgTextOverhead;

            document.getElementById('step2').textContent = 
`Total Characters/Month = ${totalMessages.toFixed(0)} √ó ${avgMessageLength} = ${totalTextChars.toLocaleString()}
Text Storage (raw) = ${formatBytes(textStorageBytes)}
Text Storage (compressed ${compressionRatio}x) = ${formatBytes(textCompressed)}
Redis Text Storage (with 30% metadata) = ${formatBytes(textStorageRedis)}
PostgreSQL Text Storage (with 40% metadata) = ${formatBytes(textStoragePg)}`;

            // Step 3: Calculate embedding chunks
            const avgChunksPerMessage = Math.ceil(avgMessageLength / chunkSize);
            const totalChunks = totalMessages * avgChunksPerMessage;

            document.getElementById('step3').textContent = 
`Chunks per Message = ceil(${avgMessageLength} / ${chunkSize}) = ${avgChunksPerMessage}
Total Chunks/Month = ${totalMessages.toFixed(0)} √ó ${avgChunksPerMessage} = ${totalChunks.toFixed(0)}`;

            // Step 4: Calculate vector storage with realistic index overhead
            const bytesPerVector = embeddingDims * 4; // float32 = 4 bytes
            const vectorStorageBytes = totalChunks * bytesPerVector;
            const vectorStorageWithIndex = vectorStorageBytes * vectorIndexMultiplier;

            document.getElementById('step4').textContent = 
`Bytes per Vector = ${embeddingDims} dimensions √ó 4 bytes = ${bytesPerVector.toLocaleString()} bytes
Vector Storage (raw) = ${totalChunks.toFixed(0)} √ó ${formatBytes(bytesPerVector)} = ${formatBytes(vectorStorageBytes)}
Vector Storage (with ${vectorIndexMultiplier}x index) = ${formatBytes(vectorStorageWithIndex)}`;

            // Step 5: Calculate total with replication and backup
            const monthlyRedisBase = textStorageRedis + vectorStorageWithIndex;
            const monthlyPgBase = textStoragePg + vectorStorageWithIndex;
            
            const monthlyRedis = monthlyRedisBase * replicationFactor * (includeBackup ? 2 : 1);
            const monthlyPg = monthlyPgBase * replicationFactor * (includeBackup ? 2 : 1);

            const annualRedis = monthlyRedis * retentionMonths;
            const annualPg = monthlyPg * retentionMonths;

            document.getElementById('step5').textContent = 
`Base Monthly Storage:
  Redis = ${formatBytes(textStorageRedis)} + ${formatBytes(vectorStorageWithIndex)} = ${formatBytes(monthlyRedisBase)}
  PostgreSQL = ${formatBytes(textStoragePg)} + ${formatBytes(vectorStorageWithIndex)} = ${formatBytes(monthlyPgBase)}

With Replication (${replicationFactor}x) and Backup (${includeBackup ? 'Yes' : 'No'}):
  Redis Monthly = ${formatBytes(monthlyRedisBase)} √ó ${replicationFactor} √ó ${includeBackup ? 2 : 1} = ${formatBytes(monthlyRedis)}
  PostgreSQL Monthly = ${formatBytes(monthlyPgBase)} √ó ${replicationFactor} √ó ${includeBackup ? 2 : 1} = ${formatBytes(monthlyPg)}

Annual (${retentionMonths} months retention):
  Redis Annual = ${formatBytes(monthlyRedis)} √ó ${retentionMonths} = ${formatBytes(annualRedis)}
  PostgreSQL Annual = ${formatBytes(monthlyPg)} √ó ${retentionMonths} = ${formatBytes(annualPg)}`;

            // Step 6: Calculate costs (CORRECTED with accurate pricing)
            // Note: annualRedis/annualPg represent TOTAL storage after retention period
            // For cost calculation, we need AVERAGE monthly storage
            const monthlyRedisAvg = annualRedis / retentionMonths;
            const monthlyPgAvg = annualPg / retentionMonths;
            
            const redisGB = monthlyRedisAvg / (1024**3);
            const pgGB = monthlyPgAvg / (1024**3);

            // Redis: Variable per provider ($35-80/GB/month) √ó 12 months
            const redisAnnualCost = redisGB * redisMonthlyRate * 12;

            // PostgreSQL: $0.115/GB/month for storage + compute
            const pgStorageCostAnnual = pgGB * 0.115 * 12;
            const pgComputeCostAnnual = pgComputeMonthlyCost * 12;
            const pgTotalAnnualCost = pgStorageCostAnnual + pgComputeCostAnnual;

            const savings = redisAnnualCost - pgTotalAnnualCost;
            const savingsPercent = ((savings / redisAnnualCost) * 100).toFixed(1);

            document.getElementById('step6').textContent = 
`Redis Stack (in-memory):
  Total Accumulated Storage (${retentionMonths} months) = ${formatBytes(annualRedis)}
  Average Monthly Storage = ${formatBytes(monthlyRedisAvg)} (${redisGB.toFixed(2)} GB)
  Rate = $${redisMonthlyRate}/GB/month (selected provider)
  Annual Cost = ${redisGB.toFixed(2)} GB √ó $${redisMonthlyRate}/mo √ó 12 = ${formatCurrency(redisAnnualCost)}

PostgreSQL + pgvector (disk):
  Total Accumulated Storage (${retentionMonths} months) = ${formatBytes(annualPg)}
  Average Monthly Storage = ${formatBytes(monthlyPgAvg)} (${pgGB.toFixed(2)} GB)
  Storage Cost = ${pgGB.toFixed(2)} GB √ó $0.115/month √ó 12 = ${formatCurrency(pgStorageCostAnnual)}
  Compute Cost = $${pgComputeMonthlyCost}/month √ó 12 = ${formatCurrency(pgComputeCostAnnual)}
  Total Annual Cost = ${formatCurrency(pgTotalAnnualCost)}

Savings with PostgreSQL = ${formatCurrency(Math.abs(savings))} (${Math.abs(savingsPercent)}% ${savings > 0 ? 'cheaper' : 'more expensive'})`;

            // Display results
            document.getElementById('monthlyText').textContent = `Redis: ${formatBytes(textStorageRedis)} | PG: ${formatBytes(textStoragePg)}`;
            document.getElementById('monthlyVectors').textContent = formatBytes(vectorStorageWithIndex);
            document.getElementById('monthlyTotal').textContent = `Redis: ${formatBytes(monthlyRedis)} | PG: ${formatBytes(monthlyPg)}`;
            document.getElementById('annualTotal').textContent = `Redis: ${formatBytes(annualRedis)} | PG: ${formatBytes(annualPg)}`;

            // Cost display
            document.getElementById('redisCostTotal').textContent = formatCurrency(redisAnnualCost) + '/year';
            document.getElementById('pgCostTotal').textContent = formatCurrency(pgTotalAnnualCost) + '/year';
            document.getElementById('savings').textContent = formatCurrency(Math.abs(savings)) + ` (${Math.abs(savingsPercent)}% ${savings > 0 ? 'cheaper' : 'more expensive'})`;

            // Update comparison table
            document.getElementById('redisStorageCost').textContent = formatCurrency(redisAnnualCost) + '/year';
            document.getElementById('pgStorageCost').textContent = formatCurrency(pgStorageCostAnnual) + '/year (storage only)';
            document.getElementById('pgComputeCost').textContent = formatCurrency(pgComputeCostAnnual) + '/year (compute)';
            
            // Add total cost row detail
            const comparisonNote = ` (Total: ${formatCurrency(pgTotalAnnualCost)}/year)`;
            document.getElementById('pgStorageCost').textContent += comparisonNote;

            // Highlight winner
            const redisBetter = redisAnnualCost < pgTotalAnnualCost;
            const winnerText = redisBetter ? 'Redis Stack' : 'PostgreSQL + pgvector';
            
            document.getElementById('redisRecommendation').textContent = redisBetter ? '‚úÖ Best for this use case' : 'High-speed retrieval, smaller datasets';
            document.getElementById('pgRecommendation').textContent = !redisBetter ? '‚úÖ Best for this use case' : 'Large datasets, cost efficiency';
            
            if (redisBetter) {
                document.getElementById('redisRecommendation').parentElement.classList.add('winner');
                document.getElementById('pgRecommendation').parentElement.classList.remove('winner');
            } else {
                document.getElementById('pgRecommendation').parentElement.classList.add('winner');
                document.getElementById('redisRecommendation').parentElement.classList.remove('winner');
            }

            // Generate recommendations
            let recommendations = '<ul>';
            
            const redisCheaper = redisAnnualCost < pgTotalAnnualCost;
            const costDiff = Math.abs(savings);
            
            if (pgGB > 100) {
                recommendations += `<li><strong>${redisCheaper ? '‚ö†Ô∏è' : '‚úÖ'} Storage Scale:</strong> Your storage exceeds 100GB (${pgGB.toFixed(1)}GB). `;
                if (redisCheaper) {
                    recommendations += `Despite high storage, your chosen Redis provider (${document.getElementById('redisProvider').selectedOptions[0].text}) is still ${formatCurrency(costDiff)} cheaper than PostgreSQL with ${document.getElementById('postgresComputeSize').selectedOptions[0].text} compute.`;
                } else {
                    recommendations += `PostgreSQL is ${formatCurrency(costDiff)} cheaper annually than in-memory Redis for this scale.`;
                }
                recommendations += '</li>';
            } else if (pgGB < 20) {
                recommendations += `<li><strong>‚úÖ Modest Storage:</strong> With only ${pgGB.toFixed(1)}GB of storage, `;
                if (redisCheaper) {
                    recommendations += `Redis is ${formatCurrency(costDiff)} cheaper and offers superior performance. Good fit for your use case.`;
                } else {
                    recommendations += `PostgreSQL is still ${formatCurrency(costDiff)} cheaper. Redis's performance benefits may justify the premium if sub-millisecond response times are critical.`;
                }
                recommendations += '</li>';
            } else {
                recommendations += `<li><strong>‚öñÔ∏è Medium Storage (${pgGB.toFixed(1)}GB):</strong> `;
                if (costDiff < 1000) {
                    recommendations += `Costs are nearly identical (difference: ${formatCurrency(costDiff)}). Choose based on: Redis for speed, PostgreSQL for operational simplicity.`;
                } else {
                    recommendations += `${redisCheaper ? 'Redis' : 'PostgreSQL'} is ${formatCurrency(costDiff)} cheaper (${Math.abs(savingsPercent)}%). `;
                    recommendations += redisCheaper ? 'Redis wins on both cost and performance here.' : 'PostgreSQL offers significant cost savings.';
                }
                recommendations += '</li>';
            }

            if (totalUsers >= 500) {
                recommendations += '<li><strong>üè¢ Multi-tenancy:</strong> With 500+ users, PostgreSQL\'s native relational structure (user_id foreign keys, row-level security) is cleaner than Redis key prefixing patterns.</li>';
            }

            // Provider-specific recommendations
            const selectedProvider = document.getElementById('redisProvider').selectedOptions[0].text;
            if (redisMonthlyRate <= 40) {
                recommendations += `<li><strong>üí∞ Provider Choice:</strong> You selected ${selectedProvider}, one of the more cost-effective Redis options. If performance meets your needs, this is a smart choice.</li>`;
            } else if (redisMonthlyRate >= 70) {
                recommendations += `<li><strong>üí∏ Premium Provider:</strong> ${selectedProvider} is at the higher end of Redis pricing. Consider Google Memorystore (~$35/GB/mo) or AWS ElastiCache (~$58/GB/mo) if cost is a concern.</li>`;
            }

            // Compute tier recommendations
            const pgComputeTier = document.getElementById('postgresComputeSize').selectedOptions[0].text;
            if (totalMessages > 100000 && pgComputeMonthlyCost < 200) {
                recommendations += `<li><strong>‚ö° Compute Sizing:</strong> With ${totalMessages.toFixed(0)} messages/month, you may need more than ${pgComputeTier}. Consider upgrading to Heavy or Enterprise tier for production loads.</li>`;
            } else if (totalMessages < 30000 && pgComputeMonthlyCost > 200) {
                recommendations += `<li><strong>üí° Over-provisioned:</strong> With only ${totalMessages.toFixed(0)} messages/month, ${pgComputeTier} may be more than you need. Consider downgrading to save costs.</li>`;
            }

            if (retentionMonths > 6) {
                recommendations += `<li><strong>üå°Ô∏è Hot/Cold Storage:</strong> With ${retentionMonths} months retention, consider tiered storage: Redis for last 30 days (hot), PostgreSQL for older data (cold). Can save 40-60% vs all-Redis.</li>`;
            }

            if (embeddingDims >= 1536) {
                recommendations += `<li><strong>üî¨ Dimension Reduction:</strong> Your ${embeddingDims}-dim embeddings are large. Consider: (1) Smaller models (768-dim), (2) PCA reduction, or (3) Product quantization to cut vector storage by 50-75%.</li>`;
            }

            if (compressionRatio < 0.7) {
                recommendations += '<li><strong>‚úÖ Good Compression:</strong> Your compression ratio is helping reduce text storage significantly. Ensure older messages are compressed more aggressively than recent ones.</li>';
            }

            if (replicationFactor > 2) {
                recommendations += '<li><strong>‚ö†Ô∏è High Replication:</strong> 3x replication is expensive. Consider 2x replication + separate backup storage (cheaper) unless you need multi-region active-active.</li>';
            }

            recommendations += '<li><strong>üìä Monitoring:</strong> Track actual query patterns. If 90% of queries hit last 7 days of data, aggressive tiering can dramatically reduce costs.</li>';
            
            recommendations += '<li><strong>üîÑ Migration Path:</strong> Start with PostgreSQL for cost efficiency. If query performance becomes an issue, add Redis as a read-through cache (hybrid approach) rather than full migration.</li>';
            
            recommendations += `<li><strong>üíé Commitment Discounts:</strong> Both Redis and PostgreSQL offer 1-3 year reserved instances with 30-60% savings. If you're confident in your usage, this could save you ${formatCurrency((redisAnnualCost + pgTotalAnnualCost) * 0.4)} annually.</li>`;
            
            recommendations += '</ul>';

            document.getElementById('recommendations').innerHTML = recommendations;

            // Show results
            document.getElementById('results').style.display = 'block';
            document.getElementById('breakdown').style.display = 'block';
            document.getElementById('costChart').style.display = 'block';

            // Create cost comparison chart
            createCostChart(redisAnnualCost, pgStorageCostAnnual, pgComputeCostAnnual, pgTotalAnnualCost);
            
            // Generate insights
            generateCostInsights(redisGB, pgGB, redisAnnualCost, pgTotalAnnualCost, totalMessages, retentionMonths);

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        let costChart = null;

        function createCostChart(redisTotal, pgStorage, pgCompute, pgTotal) {
            const ctx = document.getElementById('costComparisonChart');
            
            // Destroy existing chart if it exists
            if (costChart) {
                costChart.destroy();
            }

            costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Redis Stack\n(In-Memory)', 'PostgreSQL + pgvector\n(Disk)'],
                    datasets: [
                        {
                            label: 'Storage Cost',
                            data: [redisTotal, pgStorage],
                            backgroundColor: '#e74c3c',
                            borderColor: '#c0392b',
                            borderWidth: 2
                        },
                        {
                            label: 'Compute Cost',
                            data: [0, pgCompute],
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Annual Cost Comparison: Storage vs Compute',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                    return label;
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        total += tooltipItem.parsed.y;
                                    });
                                    return 'Total: $' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Annual Cost (USD)'
                            }
                        }
                    }
                }
            });
        }

        function generateCostInsights(redisGB, pgGB, redisCost, pgCost, messagesPerMonth, retentionMonths) {
            const savings = redisCost - pgCost;
            const savingsPercent = ((savings / redisCost) * 100).toFixed(1);
            const costPerMessage = (pgCost / (messagesPerMonth * 12)).toFixed(4);
            const storageCostRatio = (9.54 / pgCost * 100).toFixed(1); // PostgreSQL storage is ~$9.54/year
            
            let insights = '<ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">';
            
            // Main cost driver
            if (storageCostRatio < 1) {
                insights += `<li><strong>PostgreSQL is 99% compute cost</strong> - only ${storageCostRatio}% goes to storage. The disk is essentially free compared to compute.</li>`;
            } else {
                insights += `<li><strong>Compute dominates PostgreSQL cost</strong> - ${storageCostRatio}% is storage, rest is compute instances.</li>`;
            }
            
            // Cost per message
            insights += `<li><strong>Cost per message:</strong> $${costPerMessage} (PostgreSQL) - incredibly efficient at scale.</li>`;
            
            // Storage efficiency
            const storageEfficiency = (redisGB / pgGB * 100).toFixed(1);
            insights += `<li><strong>Storage efficiency:</strong> Both use ~${pgGB.toFixed(1)}GB with similar overhead.</li>`;
            
            // Break-even analysis
            if (savings > 0) {
                const monthsToBreakEven = (savings / (redisCost / 12 - pgCost / 12)).toFixed(1);
                insights += `<li><strong>ROI:</strong> PostgreSQL saves ${formatCurrency(savings)}/year (${savingsPercent}% cheaper).</li>`;
            } else {
                insights += `<li><strong>Redis premium:</strong> ${formatCurrency(Math.abs(savings))}/year more for sub-millisecond query times.</li>`;
            }
            
            insights += '</ul>';
            
            document.getElementById('costInsights').innerHTML = insights;
            
            // Generate projections
            let projections = '<ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">';
            
            // Project at 2x scale
            const redis2x = redisCost * 2;
            const pg2x = pgCost * 1.5; // Storage doubles, but same compute
            projections += `<li><strong>At 2x data (${(messagesPerMonth * 2).toLocaleString()} msgs/mo):</strong><br>Redis: ${formatCurrency(redis2x)}/yr | PostgreSQL: ${formatCurrency(pg2x)}/yr</li>`;
            
            // Project at 5x scale
            const redis5x = redisCost * 5;
            const pg5x = (9.54 * 5) + (150 * 1.5 * 12); // Storage 5x, compute 1.5x (bigger instance)
            projections += `<li><strong>At 5x data (${(messagesPerMonth * 5).toLocaleString()} msgs/mo):</strong><br>Redis: ${formatCurrency(redis5x)}/yr | PostgreSQL: ${formatCurrency(pg5x)}/yr</li>`;
            
            // With reserved instances
            const redisReserved = redisCost * 0.5; // ~50% discount
            const pgReserved = pgCost * 0.6; // ~40% discount (less on storage)
            projections += `<li><strong>With 3-year reserved pricing:</strong><br>Redis: ${formatCurrency(redisReserved)}/yr | PostgreSQL: ${formatCurrency(pgReserved)}/yr</li>`;
            
            projections += '</ul>';
            
            document.getElementById('costProjections').innerHTML = projections;
        }
    </script>
</body>
</html>